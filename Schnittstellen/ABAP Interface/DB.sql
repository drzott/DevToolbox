
CREATE TABLE [dbo].[IMP_SAP_Bestellanforderung_IMP](
	[MANDT] [varchar](500) NULL,
	[BANFN] [varchar](500) NULL,
	[BNFPO] [varchar](500) NULL,
	[BSART] [varchar](500) NULL,
	[BSTYP] [varchar](500) NULL,
	[BSAKZ] [varchar](500) NULL,
	[LOEKZ] [varchar](500) NULL,
	[STATU] [varchar](500) NULL,
	[ESTKZ] [varchar](500) NULL,
	[FRGKZ] [varchar](500) NULL,
	[FRGZU] [varchar](500) NULL,
	[FRGST] [varchar](500) NULL,
	[EKGRP] [varchar](500) NULL,
	[ERNAM] [varchar](500) NULL,
	[ERDAT] [varchar](500) NULL,
	[AFNAM] [varchar](500) NULL,
	[TXZ01] [varchar](500) NULL,
	[MATNR] [varchar](500) NULL,
	[EMATN] [varchar](500) NULL,
	[WERKS] [varchar](500) NULL,
	[LGORT] [varchar](500) NULL,
	[BEDNR] [varchar](500) NULL,
	[MATKL] [varchar](500) NULL,
	[MENGE] [varchar](500) NULL,
	[MEINS] [varchar](500) NULL,
	[BUMNG] [varchar](500) NULL,
	[BADAT] [varchar](500) NULL,
	[LPEIN] [varchar](500) NULL,
	[LFDAT] [varchar](500) NULL,
	[FRGDT] [varchar](500) NULL,
	[WEBAZ] [varchar](500) NULL,
	[PREIS] [varchar](500) NULL,
	[PEINH] [varchar](500) NULL,
	[PSTYP] [varchar](500) NULL,
	[KNTTP] [varchar](500) NULL,
	[KZVBR] [varchar](500) NULL,
	[VRTKZ] [varchar](500) NULL,
	[TWRKZ] [varchar](500) NULL,
	[WEPOS] [varchar](500) NULL,
	[WEUNB] [varchar](500) NULL,
	[REPOS] [varchar](500) NULL,
	[LIFNR] [varchar](500) NULL,
	[FLIEF] [varchar](500) NULL,
	[EKORG] [varchar](500) NULL,
	[VRTYP] [varchar](500) NULL,
	[KONNR] [varchar](500) NULL,
	[KTPNR] [varchar](500) NULL,
	[INFNR] [varchar](500) NULL,
	[DISPO] [varchar](500) NULL,
	[SERNR] [varchar](500) NULL,
	[BVDRK] [varchar](500) NULL,
	[EBELN] [varchar](500) NULL,
	[EBELP] [varchar](500) NULL,
	[BEDAT] [varchar](500) NULL,
	[BSMNG] [varchar](500) NULL,
	[LBLNI] [varchar](500) NULL,
	[BWTAR] [varchar](500) NULL,
	[EBAKZ] [varchar](500) NULL,
	[FIXKZ] [varchar](500) NULL,
	[BMEIN] [varchar](500) NULL,
	[FRGGR] [varchar](500) NULL,
	[FRGRL] [varchar](500) NULL,
	[CHARG] [varchar](500) NULL,
	[UMSOK] [varchar](500) NULL,
	[MNG02] [varchar](500) NULL,
	[DAT01] [varchar](500) NULL,
	[ATTYP] [varchar](500) NULL,
	[KUNNR] [varchar](500) NULL,
	[WAERS] [varchar](500) NULL,
	[FORDN] [varchar](500) NULL,
	[FORDP] [varchar](500) NULL,
	[PLIFZ] [varchar](500) NULL,
	[FKBER] [varchar](500) NULL,
	[MEMORY] [varchar](500) NULL,
	[BANPR] [varchar](500) NULL,
	[RLWRT] [varchar](500) NULL,
	[REVNO] [varchar](500) NULL,
	[BLCKT] [varchar](500) NULL,
	[BESWK] [varchar](500) NULL,
	[GMMNG] [varchar](500) NULL,
	[PRIO_URG] [varchar](500) NULL,
	[PRIO_REQ] [varchar](500) NULL,
	[ADVCODE] [varchar](500) NULL,
	[STACODE] [varchar](500) NULL
) ON [PRIMARY]

GO

SET ANSI_PADDING OFF
GO





CREATE TABLE [dbo].[IMP_SAP_Bestellanforderung](
	[Id] [bigint] IDENTITY(1,1) NOT NULL,
	[MANDT] [varchar](500) NULL,
	[BANFN] [varchar](500) NULL,
	[BNFPO] [varchar](500) NULL,
	[BSART] [varchar](500) NULL,
	[BSTYP] [varchar](500) NULL,
	[BSAKZ] [varchar](500) NULL,
	[LOEKZ] [varchar](500) NULL,
	[STATU] [varchar](500) NULL,
	[ESTKZ] [varchar](500) NULL,
	[FRGKZ] [varchar](500) NULL,
	[FRGZU] [varchar](500) NULL,
	[FRGST] [varchar](500) NULL,
	[EKGRP] [varchar](500) NULL,
	[ERNAM] [varchar](500) NULL,
	[ERDAT] [datetime] NULL,
	[AFNAM] [varchar](500) NULL,
	[TXZ01] [varchar](500) NULL,
	[MATNR] [varchar](500) NULL,
	[EMATN] [varchar](500) NULL,
	[WERKS] [varchar](500) NULL,
	[LGORT] [varchar](500) NULL,
	[BEDNR] [varchar](500) NULL,
	[MATKL] [varchar](500) NULL,
	[MENGE] [float] NULL,
	[MEINS] [varchar](500) NULL,
	[BUMNG] [float] NULL,
	[BADAT] [datetime] NULL,
	[LPEIN] [varchar](500) NULL,
	[LFDAT] [datetime] NULL,
	[FRGDT] [datetime] NULL,
	[WEBAZ] [varchar](500) NULL,
	[PREIS] [float] NULL,
	[PEINH] [varchar](500) NULL,
	[PSTYP] [varchar](500) NULL,
	[KNTTP] [varchar](500) NULL,
	[KZVBR] [varchar](500) NULL,
	[VRTKZ] [varchar](500) NULL,
	[TWRKZ] [varchar](500) NULL,
	[WEPOS] [varchar](500) NULL,
	[WEUNB] [varchar](500) NULL,
	[REPOS] [varchar](500) NULL,
	[LIFNR] [varchar](500) NULL,
	[FLIEF] [varchar](500) NULL,
	[EKORG] [varchar](500) NULL,
	[VRTYP] [varchar](500) NULL,
	[KONNR] [varchar](500) NULL,
	[KTPNR] [varchar](500) NULL,
	[INFNR] [varchar](500) NULL,
	[DISPO] [varchar](500) NULL,
	[SERNR] [varchar](500) NULL,
	[BVDRK] [varchar](500) NULL,
	[EBELN] [varchar](500) NULL,
	[EBELP] [varchar](500) NULL,
	[BEDAT] [datetime] NULL,
	[BSMNG] [float] NULL,
	[LBLNI] [varchar](500) NULL,
	[BWTAR] [varchar](500) NULL,
	[EBAKZ] [varchar](500) NULL,
	[FIXKZ] [varchar](500) NULL,
	[BMEIN] [varchar](500) NULL,
	[FRGGR] [varchar](500) NULL,
	[FRGRL] [varchar](500) NULL,
	[CHARG] [varchar](500) NULL,
	[UMSOK] [varchar](500) NULL,
	[MNG02] [varchar](500) NULL,
	[DAT01] [varchar](500) NULL,
	[ATTYP] [varchar](500) NULL,
	[KUNNR] [varchar](500) NULL,
	[WAERS] [varchar](500) NULL,
	[FORDN] [varchar](500) NULL,
	[FORDP] [varchar](500) NULL,
	[PLIFZ] [varchar](500) NULL,
	[FKBER] [varchar](500) NULL,
	[MEMORY] [varchar](500) NULL,
	[BANPR] [varchar](500) NULL,
	[RLWRT] [float] NULL,
	[REVNO] [varchar](500) NULL,
	[BLCKT] [varchar](500) NULL,
	[BESWK] [varchar](500) NULL,
	[GMMNG] [float] NULL,
	[PRIO_URG] [varchar](500) NULL,
	[PRIO_REQ] [varchar](500) NULL,
	[ADVCODE] [varchar](500) NULL,
	[STACODE] [varchar](500) NULL,
	[Import_Date] [datetime] NULL,
 CONSTRAINT [PK_IMP_SAP_Bestellanforderung] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

SET ANSI_PADDING OFF
GO





CREATE procedure [dbo].[SP_Import_SAP_Bestellanforderungen] @ImportDatum as datetime as 

TRUNCATE TABLE KPI_Import..IMP_SAP_Bestellanforderung_IMP

INSERT INTO KPI_Import..IMP_SAP_Bestellanforderung_IMP
	(
	MANDT,
	BANFN,
	BNFPO,
	BSART,
	BSTYP,
	BSAKZ,
	LOEKZ,
	STATU,
	ESTKZ,
	FRGKZ,
	FRGZU,
	FRGST,
	EKGRP,
	ERNAM,
	ERDAT,
	AFNAM,
	TXZ01,
	MATNR,
	EMATN,
	WERKS,
	LGORT,
	BEDNR,
	MATKL,
	MENGE,
	MEINS,
	BUMNG,
	BADAT,
	LPEIN,
	LFDAT,
	FRGDT,
	WEBAZ,
	PREIS,
	PEINH,
	PSTYP,
	KNTTP,
	KZVBR,
	VRTKZ,
	TWRKZ,
	WEPOS,
	WEUNB,
	REPOS,
	LIFNR,
	FLIEF,
	EKORG,
	VRTYP,
	KONNR,
	KTPNR,
	INFNR,
	DISPO,
	SERNR,
	BVDRK,
	EBELN,
	EBELP,
	BEDAT,
	BSMNG,
	LBLNI,
	BWTAR,
	EBAKZ,
	FIXKZ,
	BMEIN,
	FRGGR,
	FRGRL,
	CHARG,
	UMSOK,
	MNG02,
	DAT01,
	ATTYP,
	KUNNR,
	WAERS,
	FORDN,
	FORDP,
	PLIFZ,
	FKBER,
	MEMORY,
	BANPR,
	RLWRT,
	REVNO,
	BLCKT,
	BESWK,
	GMMNG,
	PRIO_URG,
	PRIO_REQ,
	ADVCODE,
	STACODE
	)
SELECT 

	LTRIM(RTRIM(MANDT)),
	LTRIM(RTRIM(BANFN)),
	LTRIM(RTRIM(BNFPO)),
	LTRIM(RTRIM(BSART)),
	LTRIM(RTRIM(BSTYP)),
	LTRIM(RTRIM(BSAKZ)),
	LTRIM(RTRIM(LOEKZ)),
	LTRIM(RTRIM(STATU)),
	LTRIM(RTRIM(ESTKZ)),
	LTRIM(RTRIM(FRGKZ)),
	LTRIM(RTRIM(FRGZU)),
	LTRIM(RTRIM(FRGST)),
	LTRIM(RTRIM(EKGRP)),
	LTRIM(RTRIM(ERNAM)),
	LTRIM(RTRIM(ERDAT)),
	LTRIM(RTRIM(AFNAM)),
	LTRIM(RTRIM(TXZ01)),
	LTRIM(RTRIM(MATNR)),
	LTRIM(RTRIM(EMATN)),
	LTRIM(RTRIM(WERKS)),
	LTRIM(RTRIM(LGORT)),
	LTRIM(RTRIM(BEDNR)),
	LTRIM(RTRIM(MATKL)),
	LTRIM(RTRIM(MENGE)),
	LTRIM(RTRIM(MEINS)),
	LTRIM(RTRIM(BUMNG)),
	LTRIM(RTRIM(BADAT)),
	LTRIM(RTRIM(LPEIN)),
	LTRIM(RTRIM(LFDAT)),
	LTRIM(RTRIM(FRGDT)),
	LTRIM(RTRIM(WEBAZ)),
	LTRIM(RTRIM(PREIS)),
	LTRIM(RTRIM(PEINH)),
	LTRIM(RTRIM(PSTYP)),
	LTRIM(RTRIM(KNTTP)),
	LTRIM(RTRIM(KZVBR)),
	LTRIM(RTRIM(VRTKZ)),
	LTRIM(RTRIM(TWRKZ)),
	LTRIM(RTRIM(WEPOS)),
	LTRIM(RTRIM(WEUNB)),
	LTRIM(RTRIM(REPOS)),
	LTRIM(RTRIM(LIFNR)),
	LTRIM(RTRIM(FLIEF)),
	LTRIM(RTRIM(EKORG)),
	LTRIM(RTRIM(VRTYP)),
	LTRIM(RTRIM(KONNR)),
	LTRIM(RTRIM(KTPNR)),
	LTRIM(RTRIM(INFNR)),
	LTRIM(RTRIM(DISPO)),
	LTRIM(RTRIM(SERNR)),
	LTRIM(RTRIM(BVDRK)),
	LTRIM(RTRIM(EBELN)),
	LTRIM(RTRIM(EBELP)),
	LTRIM(RTRIM(BEDAT)),
	LTRIM(RTRIM(BSMNG)),
	LTRIM(RTRIM(LBLNI)),
	LTRIM(RTRIM(BWTAR)),
	LTRIM(RTRIM(EBAKZ)),
	LTRIM(RTRIM(FIXKZ)),
	LTRIM(RTRIM(BMEIN)),
	LTRIM(RTRIM(FRGGR)),
	LTRIM(RTRIM(FRGRL)),
	LTRIM(RTRIM(CHARG)),
	LTRIM(RTRIM(UMSOK)),
	LTRIM(RTRIM(MNG02)),
	LTRIM(RTRIM(DAT01)),
	LTRIM(RTRIM(ATTYP)),
	LTRIM(RTRIM(KUNNR)),
	LTRIM(RTRIM(WAERS)),
	LTRIM(RTRIM(FORDN)),
	LTRIM(RTRIM(FORDP)),
	LTRIM(RTRIM(PLIFZ)),
	LTRIM(RTRIM(FKBER)),
	LTRIM(RTRIM(MEMORY)),
	LTRIM(RTRIM(BANPR)),
	LTRIM(RTRIM(RLWRT)),
	LTRIM(RTRIM(REVNO)),
	LTRIM(RTRIM(BLCKT)),
	LTRIM(RTRIM(BESWK)),
	LTRIM(RTRIM(GMMNG)),
	LTRIM(RTRIM(PRIO_URG)),
	LTRIM(RTRIM(PRIO_REQ)),
	LTRIM(RTRIM(ADVCODE)),
	LTRIM(RTRIM(STACODE))

FROM OPENROWSET(BULK '\\xxx\kpi$\SAP\SAP_eban.txt', 
FORMATFILE = '\\xxx\kpi$\FormatDateien\SAP\SAP_EBAN.fmt', FIRSTROW=1) AS A


DELETE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP WHERE MANDT = 'EBAN-MANDT'

-- Verifikation

UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET ERDAT = NULL WHERE ISDATE(ERDAT) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET BADAT = NULL WHERE ISDATE(BADAT) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET LFDAT = NULL WHERE ISDATE(LFDAT) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET FRGDT = NULL WHERE ISDATE(FRGDT) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET BEDAT = NULL WHERE ISDATE(BEDAT) = 0

UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET MENGE = NULL WHERE ISNUMERIC(MENGE) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET BUMNG = NULL WHERE ISNUMERIC(BUMNG) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET PREIS = NULL WHERE ISNUMERIC(PREIS) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET BSMNG = NULL WHERE ISNUMERIC(BSMNG) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET RLWRT = NULL WHERE ISNUMERIC(RLWRT) = 0
UPDATE KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP SET GMMNG = NULL WHERE ISNUMERIC(GMMNG) = 0


DELETE X
FROM KPI_IMPORT..IMP_SAP_Bestellanforderung as X
		INNER JOIN KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP as Y
			ON	ISNULL(X.BANFN,'') = ISNULL(Y.BANFN,'')
			AND ISNULL(X.BNFPO,'') = ISNULL(Y.BNFPO,'')


INSERT INTO KPI_IMPORT..IMP_SAP_Bestellanforderung
	(
	MANDT,
	BANFN,
	BNFPO,
	BSART,
	BSTYP,
	BSAKZ,
	LOEKZ,
	STATU,
	ESTKZ,
	FRGKZ,
	FRGZU,
	FRGST,
	EKGRP,
	ERNAM,
	ERDAT,
	AFNAM,
	TXZ01,
	MATNR,
	EMATN,
	WERKS,
	LGORT,
	BEDNR,
	MATKL,
	MENGE,
	MEINS,
	BUMNG,
	BADAT,
	LPEIN,
	LFDAT,
	FRGDT,
	WEBAZ,
	PREIS,
	PEINH,
	PSTYP,
	KNTTP,
	KZVBR,
	VRTKZ,
	TWRKZ,
	WEPOS,
	WEUNB,
	REPOS,
	LIFNR,
	FLIEF,
	EKORG,
	VRTYP,
	KONNR,
	KTPNR,
	INFNR,
	DISPO,
	SERNR,
	BVDRK,
	EBELN,
	EBELP,
	BEDAT,
	BSMNG,
	LBLNI,
	BWTAR,
	EBAKZ,
	FIXKZ,
	BMEIN,
	FRGGR,
	FRGRL,
	CHARG,
	UMSOK,
	MNG02,
	DAT01,
	ATTYP,
	KUNNR,
	WAERS,
	FORDN,
	FORDP,
	PLIFZ,
	FKBER,
	MEMORY,
	BANPR,
	RLWRT,
	REVNO,
	BLCKT,
	BESWK,
	GMMNG,
	PRIO_URG,
	PRIO_REQ,
	ADVCODE,
	STACODE,
	Import_Date
	)
SELECT 

	MANDT,
	BANFN,
	BNFPO,
	BSART,
	BSTYP,
	BSAKZ,
	LOEKZ,
	STATU,
	ESTKZ,
	FRGKZ,
	FRGZU,
	FRGST,
	EKGRP,
	ERNAM,
	ERDAT,
	AFNAM,
	TXZ01,
	MATNR,
	EMATN,
	WERKS,
	LGORT,
	BEDNR,
	MATKL,
	MENGE,
	MEINS,
	BUMNG,
	BADAT,
	LPEIN,
	LFDAT,
	FRGDT,
	WEBAZ,
	PREIS,
	PEINH,
	PSTYP,
	KNTTP,
	KZVBR,
	VRTKZ,
	TWRKZ,
	WEPOS,
	WEUNB,
	REPOS,
	LIFNR,
	FLIEF,
	EKORG,
	VRTYP,
	KONNR,
	KTPNR,
	INFNR,
	DISPO,
	SERNR,
	BVDRK,
	EBELN,
	EBELP,
	BEDAT,
	BSMNG,
	LBLNI,
	BWTAR,
	EBAKZ,
	FIXKZ,
	BMEIN,
	FRGGR,
	FRGRL,
	CHARG,
	UMSOK,
	MNG02,
	DAT01,
	ATTYP,
	KUNNR,
	WAERS,
	FORDN,
	FORDP,
	PLIFZ,
	FKBER,
	MEMORY,
	BANPR,
	RLWRT,
	REVNO,
	BLCKT,
	BESWK,
	GMMNG,
	PRIO_URG,
	PRIO_REQ,
	ADVCODE,
	STACODE,
	@ImportDatum
FROM KPI_IMPORT..IMP_SAP_Bestellanforderung_IMP

GO

